name: Buf Generate & Commit SDKs

on:
  # proto 変更時のみトリガ
  push:
    paths:
      - 'proto/**/*.proto'
  # 手動起動
  workflow_dispatch:

jobs:
  generate-and-commit:
    # bot が push したコミットでは再実行しない
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      # ───────── チェックアウト ─────────
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0              # push するので完全履歴を取得
          token: ${{ secrets.GITHUB_TOKEN }}

      # ───────── Buf CLI ─────────
      - uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # ───────── コード生成 ─────────
      - name: Generate Go SDK
        run: buf generate --template buf.gen.go.yaml

      - name: Generate Java SDK
        run: buf generate --template buf.gen.java.yaml

      - name: Generate TypeScript SDK
        run: buf generate --template buf.gen.typescript.yaml

      # ───────── 変更をコミット ─────────
      - name: Commit & push generated code
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions@users.noreply.github.com"

          git add gen/
          # 変更があるかチェック
          if git diff --cached --quiet; then
            echo "✅ Generated code is up‑to‑date. No commit necessary." && exit 0
          fi

          COMMIT_MSG="chore(proto): regenerate SDK from updated .proto [skip ci]"
          git commit -m "$COMMIT_MSG"
          git push origin HEAD
